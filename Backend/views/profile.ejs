<!DOCTYPE html>
<html>
<head>
    <title>PACP Profile</title>
    <meta charset="UTF-8">
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 0; 
            padding: 20px; 
            line-height: 1.4;
            color: #000;
            background: #fff;
        }
        h1 { 
            text-align: center; 
            margin-bottom: 30px;
            font-size: 24px;
            color: #000;
        }
        h2 { 
            color: #000; 
            border-bottom: 2px solid #000; 
            padding-bottom: 5px;
            margin-top: 30px;
            margin-bottom: 15px;
            font-size: 18px;
        }
        table { 
            width: 100%; 
            border-collapse: collapse; 
            margin: 20px 0;
        }
        th, td { 
            border: 1px solid #000; 
            padding: 8px; 
            text-align: left; 
        }
        th { 
            border: 2px solid #000;
            font-weight: bold; 
            color: #000;
            background: none;
        }
        .profile-info { 
            border: 1px solid #000; 
            padding: 15px; 
            margin-bottom: 20px;
        }
        .section { 
            margin-bottom: 30px; 
            page-break-inside: avoid;
        }
        .status { 
            padding: 2px 6px; 
            border: 1px solid #000; 
            font-size: 11px; 
            font-weight: bold;
            display: inline-block;
            text-transform: uppercase;
            background: none;
        }
        .footer { 
            text-align: center; 
            margin-top: 40px; 
            font-size: 11px; 
            color: #000;
            border-top: 1px solid #000;
            padding-top: 15px;
        }
        .no-data {
            text-align: center;
            font-style: italic;
            padding: 20px;
        }
        @media print {
            body { margin: 0; padding: 15px; }
            .section { page-break-inside: avoid; }
        }
    </style>
</head>
<body>
    <!-- Profile Information -->
    <div class="section">
        <h2>Profile Information</h2>
        <div class="profile-info">
            <table>
                <tr>
                    <th>User ID</th>
                    <td><%= user.id %></td>
                    <th>Name</th>
                    <td><%= user.name %></td>
                </tr>
                <tr>
                    <th>Email</th>
                    <td><%= user.email %></td>
                    <th>Phone</th>
                    <td><%= user.phone %></td>
                </tr>
                <tr>
                    <th>Has RD</th>
                    <td><%= user.hasRD %></td>
                    <th>Has FD</th>
                    <td><%= user.hasFD %></td>
                </tr>
                <tr>
                    <th>Has Loan</th>
                    <td><%= user.hasLoan %></td>
                    <th>Report Date</th>
                    <td><%= generatedDate %> at <%= generatedTime %></td>
                </tr>
            </table>
        </div>
    </div>

    <!-- Recurring Deposits -->
    <% if (deposits.rd && deposits.rd.length > 0) { %>
    <div class="section">
        <h2>Recurring Deposits (RD)</h2>
        <table>
            <thead>
                <tr>
                    <th>Application No</th>
                    <th>Total Invested</th>
                    <th>Current Value</th>
                    <th>Monthly Amount</th>
                    <th>Last Deposit Date</th>
                    <th>Total Deposits</th>
                </tr>
            </thead>
            <tbody>
                <% deposits.rd.forEach(rd => { %>
                <tr>
                    <td><%= rd.applicationNumber || 'N/A' %></td>
                    <td>₹<%= rd.totalInvestedAmount || '0' %></td>
                    <td>₹<%= rd.currentInvestmentValue || '0' %></td>
                    <td>₹<%= rd.amountPerMonth || '0' %></td>
                    <td><%= rd.lastDepositeDate ? new Date(rd.lastDepositeDate).toLocaleDateString() : 'N/A' %></td>
                    <td><%= rd.rdCount || '0' %></td>
                </tr>
                <% }); %>
            </tbody>
        </table>
    </div>
    <% } else { %>
    <div class="section">
        <h2>Recurring Deposits (RD)</h2>
        <div class="no-data">No Recurring Deposits found</div>
    </div>
    <% } %>

    <!-- Fixed Deposits -->
    <% if (deposits.fd && deposits.fd.length > 0) { %>
    <div class="section">
        <h2>Fixed Deposits (FD)</h2>
        <table>
            <thead>
                <tr>
                    <th>Application No</th>
                    <th>Invested Amount</th>
                    <th>Maturity Amount</th>
                    <th>Interest Rate</th>
                    <th>Duration (Months)</th>
                    <th>Start Date</th>
                    <th>Maturity Date</th>
                </tr>
            </thead>
            <tbody>
                <% deposits.fd.forEach(fd => { %>
                <tr>
                    <td><%= fd.applicationNumber || 'N/A' %></td>
                    <td>₹<%= fd.depositAmount || '0' %></td>
                    <td>₹<%= fd.maturityAmount || '0' %></td>
                    <td><%= fd.interestRate || '0' %>%</td>
                    <td><%= fd.tenureInMonths || '0' %></td>
                    <td><%= fd.startDate ? new Date(fd.startDate).toLocaleDateString() : 'N/A' %></td>
                    <td><%= fd.maturityDate ? new Date(fd.maturityDate).toLocaleDateString() : 'N/A' %></td>
                </tr>
                <% }); %>
            </tbody>
        </table>
    </div>
    <% } else { %>
    <div class="section">
        <h2>Fixed Deposits (FD)</h2>
        <div class="no-data">No Fixed Deposits found</div>
    </div>
    <% } %>

    <!-- Loans -->
    <% if (loans && loans.length > 0) { %>
    <div class="section">
        <h2>Loans</h2>
        <table>
            <thead>
                <tr>
                    <th>Application No</th>
                    <th>Status</th>
                    <th>Disbursement Date</th>
                    <th>Loan Amount</th>
                    <th>Interest Rate</th>
                    <th>Duration (Months)</th>
                    <th>Loan Type</th>
                    <th>EMI</th>
                    <th>Next Due Date</th>
                    <th>EMIs Left</th>
                </tr>
            </thead>
            <tbody>
                <% loans.forEach(loan => { 
                    // Calculate EMI
                    let emiAmount = 'N/A';
                    if (loan.repaymentSchedule && loan.repaymentSchedule.length > 0 && loan.repaymentSchedule[0].amountDue) {
                        emiAmount = loan.repaymentSchedule[0].amountDue;
                    }
                    
                    // Calculate next due date
                    let nextDueDate = 'N/A';
                    if (loan.repaymentSchedule && loan.repaymentSchedule.length > 0) {
                        const nextDue = loan.repaymentSchedule.find(r => r.status === 'due');
                        if (nextDue && nextDue.dueDate) {
                            nextDueDate = new Date(nextDue.dueDate).toLocaleDateString();
                        } else {
                            nextDueDate = 'All EMIs Paid';
                        }
                    }
                    
                    // Calculate EMIs left
                    let emisLeft = '0';
                    if (loan.repaymentSchedule && loan.repaymentSchedule.length > 0) {
                        emisLeft = loan.repaymentSchedule.filter(r => r.status === 'due').length.toString();
                    }
                %>
                <tr>
                    <td><%= loan.loanApplicationNumber || 'N/A' %></td>
                    <td>
                        <span class="status">
                            <%= loan.status || 'Pending' %>
                        </span>
                    </td>
                    <td><%= loan.applicationDate ? new Date(loan.applicationDate).toLocaleDateString() : 'N/A' %></td>
                    <td>₹<%= loan.amount || '0' %></td>
                    <td><%= loan.interestRate || '0' %>%</td>
                    <td><%= loan.tenureInMonths || '0' %></td>
                    <td><%= loan.loanType || 'unsecured' %></td>
                    <td>₹<%= emiAmount %></td>
                    <td><%= nextDueDate %></td>
                    <td><%= emisLeft %></td>
                </tr>
                <% }); %>
            </tbody>
        </table>
    </div>
    <% } else { %>
    <div class="section">
        <h2>Loans</h2>
        <div class="no-data">No Loans found</div>
    </div>
    <% } %>

    <!-- Footer -->
    <div class="footer">
        <p><strong>Generated on:</strong> <%= generatedDate %> at <%= generatedTime %></p>
        <p><em>This is a computer-generated document from PACP Platform</em></p>
        <p>© <%= new Date().getFullYear() %> PACP - All Rights Reserved</p>
    </div>
</body>
</html>